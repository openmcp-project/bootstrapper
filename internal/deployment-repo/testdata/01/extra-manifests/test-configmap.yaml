apiVersion: v1
kind: ConfigMap
metadata:
    name: test-configmap
    namespace: default
data:
  environment: "<environment>"
  setByUserPatch: "<setByUserPatch>"
  git: |
    pullBranch: "{{ .Values.git.pullBranch }}"
    pushBranch: "{{ .Values.git.pushBranch }}"
  userProvided: |
{{ toYaml .Values.user | indent 4 }}
  key: "value"
  repository: "{{ getOCMRepository }}"
  rootComponent: "{{ dig "component" "name" "none" (componentVersionAsMap (getRootComponentVersion)) }}"
  {{- $releaseChannelCvs := getComponentVersionsByReference "releasechannel"  }}
  {{- $releaseChannelCv := index $releaseChannelCvs 0 }}
  {{- $crossplaneCvs := getComponentVersionsByReference $releaseChannelCv "crossplane"  }}
  crossplane: |
  {{- range $crossplaneCv := $crossplaneCvs }}
    {{- $crossplaneImageResource := getResourceFromComponentVersion $crossplaneCv "image-crossplane" }}
    {{- $imageReference := dig "access" "imageReference" "none" $crossplaneImageResource }}
    {{- $parsedImage := parseImage $imageReference }}
    {{- $crossplaneCvMap := componentVersionAsMap $crossplaneCv }}
    - crossplaneComponentName: "{{ dig "component" "name" "none" $crossplaneCvMap }}"
      crossplaneComponentVersion: "{{ dig "component" "version" "none" $crossplaneCvMap }}"
      crossplaneImage: "{{ dig "image" "none" $parsedImage }}:{{ dig "tag" "none" $parsedImage }}"
  {{- end }}
  platformService: |
  {{- $platformServiceCvs := getComponentVersionsForResource "platform-service-test-image" }}
  {{- $platformServiceCv := index $platformServiceCvs 0 }}
  {{- $platformServiceImageResource := getResourceFromComponentVersion $platformServiceCv "platform-service-test-image" }}
  {{- $platformServiceImageReference := dig "access" "imageReference" "none" $platformServiceImageResource }}
  {{- $platformServiceParsedImage := parseImage $platformServiceImageReference }}
    image: "{{ dig "image" "none" $platformServiceParsedImage }}"
    version: "{{ $platformServiceImageResource.version }}"